<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- Style Sheet -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
    

    <!-- JS Resource -->
    <script type="text/javascript" src="http://cdn.jsdelivr.net/jquery/1/jquery.min.js"></script>
    <script type="text/javascript" src="http://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="http://cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>
    
    
    <title>Search Panel</title>
</head>
<body>
    <div class="container">
        <!-- Form -->
        <form id="search_form" onsubmit="return onSubmit()">
            <div class="row" style="padding-top: 50px;">
                <div class="col-lg-6">
                    <!-- Search Panel -->
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="form-check form-check-inline">
                                <label class="form-check-label">
                                    <input class="form-check-input" type="radio" name="search_criteria" id="search_day" value="date" checked> Date
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <label class="form-check-label">
                                    <input class="form-check-input" type="radio" name="search_criteria" id="search_week" value="week"> Week
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <label class="form-check-label">
                                    <input class="form-check-input" type="radio" name="search_criteria" id="search_month" value="month"> Month
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <label class="form-check-label">
                                    <input class="form-check-input" type="radio" name="search_criteria" id="search_quarter" value="quarter"> Quarter
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <label class="form-check-label">
                                    <input class="form-check-input" type="radio" name="search_criteria" id="search_year" value="year"> Year
                                </label>
                            </div>
                        </div>
                    </div>
                    <hr/>
                    
                        <div class="row" id="search_content_container">
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label class="col-form-label" for="formGroupExampleInput">From</label>
                                    <input class="form-control" type="text" name="from" value="" />
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label class="col-form-label" for="formGroupExampleInput">To</label>
                                    <input class="form-control" type="text" name="to" value="" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <button type="submit" id="submit" class="btn btn-primary">Apply</button>
                                <button type="reset" class="btn btn-default">Cancel</button>
                            </div>
                        </div>
                    
                    <!-- Search Panel -->
                </div>
            </div>
            <!-- Form -->
        </form>
    </div>

    <script>
        $(function() {
            var maxDate = moment(getCurrentDate(), 'YYYYMMDD');
            $('input[name="from"]').daterangepicker({
                singleDatePicker: true,
                startDate: maxDate,
                maxDate: maxDate
            });
            $('input[name="to"]').daterangepicker({
                singleDatePicker: true,
                startDate: maxDate,
                maxDate: maxDate
            });
        });
        
        var target = document.getElementById('search_content_container');
        var form = document.getElementById('search_form');
        var maxSubtractOfYear = 5;

        var radioDay = document.getElementById('search_day');
        var radioWeek = document.getElementById('search_week');
        var radioMonth = document.getElementById('search_month');
        var radioQuarter = document.getElementById('search_quarter');
        var radioYear = document.getElementById('search_year');

        function onSubmit() {
            var allData = $("#search_form").serializeArray();
            var str = '';
            allData.forEach(function(data, index) {
                if (index == 0) {
                    str = 'searchType: ' + data.value;
                    return;
                }

                str += ', ' + data.name + ': ' + data.value;
            });

            alert(str);
            return false;
        }
        
        function getCurrentDate() {
            return '20170220';
        }

        radioDay.addEventListener('click', function() {
            target.innerHTML = getDayHtmlCriteria();
            $(function() {
                var maxDate = moment(getCurrentDate(), 'YYYYMMDD');
                $('input[name="from"]').daterangepicker({
                    singleDatePicker: true,
                    startDate: maxDate,
                    maxDate: maxDate
                });
                $('input[name="to"]').daterangepicker({
                    singleDatePicker: true,
                    startDate: maxDate,
                    maxDate: maxDate
                });
            });
        });
        radioWeek.addEventListener('click', function() {
            target.innerHTML = getWeekHtmlCriteria();
        });
        radioMonth.addEventListener('click', function() {
            target.innerHTML = getMonthHtmlCriteria();
        });
        radioQuarter.addEventListener('click', function() {
            target.innerHTML = getQuarterHtmlCriteria();
        });
        radioYear.addEventListener('click', function() {
            target.innerHTML = getYearHtmlCriteria();
        });

        function getDayHtmlCriteria() {
            return `
                <div class="col-lg-6">
                    <div class="form-group">
                        <label class="col-form-label" for="formGroupExampleInput">From</label>
                        <input class="form-control" type="text" name="from" value="" />
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="form-group">
                        <label class="col-form-label" for="formGroupExampleInput">To</label>
                        <input class="form-control" type="text" name="to" value="" />
                    </div>
                </div>
            `;
        }

        function getWeekHtmlCriteria() {
            return `
                <div class="col-lg-6">
                    <div class="form-group">
                        <label class="col-form-label" for="formGroupExampleInput">Year</label>
                        <select name="year" class="custom-select form-control">
                            <option value="2017" selected>2017</option>
                            <option value="2016">2016</option>
                            <option value="2015">2015</option>
                            <option value="2014">2014</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="form-group">
                        <label class="col-form-label" for="formGroupExampleInput">Week</label>
                        <select name="week" class="custom-select form-control">
                            <option value="w1" selected>Week 1 (1-6 January)</option>
                            <option value="w2">Week 2 (7-13 January)</option>
                            <option value="w3">Week 3 (14-20 January)</option>
                            <option value="w4">Week 4 (21-27 January)</option>
                        </select>
                    </div>
                </div>
            `;
        }

        function getMonthHtmlCriteria(setYear = null) {
            var maxDate = moment(getCurrentDate(), 'YYYYMMDD');
            var allMonths = moment.months();
            var maxYear = maxDate.year();
            var maxMonth = (setYear == null || setYear == maxYear) ? maxDate.month() : 11; // start index of month from 0
            var yearSelected = setYear == null ? maxYear : Number(setYear);
            var str =  `
                <div class="col-lg-6">
                    <div class="form-group">
                        <label class="col-form-label" for="formGroupExampleInput">Year</label>
                        <select name="year" class="custom-select form-control" id="yearOfMonthCreteria">`;
                            str += getYearOptions(maxYear, yearSelected);
                        str += `</select>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="form-group">
                        <label class="col-form-label" for="formGroupExampleInput">Month</label>
                        <select name="month" class="custom-select form-control">`;
                        for (var i=0; i<=maxMonth; i++) {
                            if (i == 0) {
                                str += `<option value="${i+1}" selected>${allMonths[i]}</option>`;
                                continue;
                            }

                            str += `<option value="${i+1}">${allMonths[i]}</option>`;
                        }

                        str += `</select>
                    </div>
                </div>
            `;

            return str;
        }

        $(target).on('change', '#yearOfMonthCreteria', function() {
            var yearSelected = $(this).find(':selected').text();
            target.innerHTML = getMonthHtmlCriteria(yearSelected);
        });

        function getQuarterHtmlCriteria(setYear = null) {
            var maxDate = moment(getCurrentDate(), 'YYYYMMDD');
            var maxYear = maxDate.year();
            var maxMonth = (setYear == null || setYear == maxYear) ? maxDate.month() : 11; // start index of month from 0
            var yearSelected = setYear == null ? maxYear : Number(setYear);
            var str = `
                <div class="col-lg-6">
                    <div class="form-group">
                        <label class="col-form-label" for="formGroupExampleInput">Year</label>
                        <select name="year" class="custom-select form-control" id="yearOfQuarterCriteria">`;
                            str += getYearOptions(maxYear, yearSelected);
                        str += `</select>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="form-group">
                        <label class="col-form-label" for="formGroupExampleInput">Quarter</label>
                        <select name="quarter" class="custom-select form-control">`;
                            for (var i=1; i<=4; i++) {
                                if (!checkQuarter(maxDate, i, setYear)) continue;
                                if (i == 1) {
                                    str += `<option value="q${i}" selected>${getLabel(i)}</option>`;
                                    continue;
                                }

                                str += `<option value="q${i}">${getLabel(i)}</option>`;
                            }

                        str += `</select>
                    </div>
                </div>
            `;

            return str;

            function checkQuarter(maxDate, index, setYear) {
                // TODO: when change year back to 2017 the quarter labels are wrong
                var thisYear = setYear == null ? maxDate.year() : setYear;
                var thisMonth = (setYear == null || maxDate.year() == setYear) ? maxDate.month() + 1 : 12;
                var tmpDate = (setYear == null || maxDate.year() == setYear) ? maxDate : moment(thisYear + '-12-31');
                switch(index) {
                    case 1: return (tmpDate.isBetween(thisYear + '-01-01', thisYear + '-03-31', null, '[]') || thisMonth > 3);
                    case 2: return (tmpDate.isBetween(thisYear + '-04-01', thisYear + '-06-30', null, '[]') || thisMonth > 6);
                    case 3: return (tmpDate.isBetween(thisYear + '-07-01', thisYear + '-09-30', null, '[]') || thisMonth > 9);
                    case 4: return tmpDate.isBetween(thisYear + '-10-01', thisYear + '-12-31', null, '[]');
                }
            }

            function getLabel(index) {
                switch(index) {
                    case 1: return 'Quarter 1(Jan 1 - March 31)';
                    case 2: return 'Quarter 2(April 1 - Jun 30)';
                    case 3: return 'Quarter 3(July 1 - September 30)';
                    case 4: return 'Quarter 4(October 1 - December 31)';
                }
            }
        }

        $(target).on('change', '#yearOfQuarterCriteria', function() {
            var yearSelected = $(this).find(':selected').text();
            target.innerHTML = getQuarterHtmlCriteria(yearSelected);
        });

        function getYearHtmlCriteria(setYear = null) {
            var maxDate = moment(getCurrentDate(), 'YYYYMMDD');
            var maxYear = maxDate.year();
            var yearSelected = setYear == null ? maxYear : Number(setYear);
            var str = `
                <div class="col-lg-6">
                    <div class="form-group">
                        <label class="col-form-label" for="formGroupExampleInput">Year</label>
                        <select name="year" class="custom-select form-control">`;
                            str += getYearOptions(maxYear, yearSelected);
                        str += `</select>
                    </div>
                </div>
            `;

            return str;
        }

        function getYearOptions(maxYear, yearSelected) {
            var str = '';
            for (var i=0; i<maxSubtractOfYear; i++) {
                var tmpYear = maxYear - i;
                if (tmpYear == yearSelected) {
                    str += `<option value="${tmpYear}" selected>${tmpYear}</option>`;
                    continue;
                }

                str += `<option value="${tmpYear}">${tmpYear}</option>`;
            }

            return str;
        }
    </script>
</body>
</html>